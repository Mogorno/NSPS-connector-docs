# Implementation Specific

## Requirements

- Authentication of all requests to the connector using a Bearer token.
- Event payload schema parsing.
- Handling specific [events][events] (e.g., SIM activated, Plan changed, etc.).
- Configurable settings for [External API server][external-api-server]:
    - API base URL with optional base path.
    - API access credentials (depends on the system implementation. This can be either Basic Auth, Bearer Auth with a static token, or support for example JWT. The connector should work with access_tokens and refresh_tokens if the system requires it).
- Response codes:
    - 2XX for a successfully processed event (with optional JSON response body).
    - 4XX and 5XX codes for unsuccessfully processed events (with human-readable error explanation in response JSON body).

An example is available here - [WTL HLR/HSS Connector][wtl-hlr/hss-connector].

The connector should provide 2 methods:

1. **GET health endpoint** is needed to check the availability of the connector itself (this method should return just 200 OK with some optional response body).
2. **POST method** is used by the [NSPS][nsps] system as a destination. The URL may or may not contain a path (options such as `https://connector.com`, `https://connector.com/api/events` are OK).

You can view or download an example of the OpenAPI specification below.

[![OpenAPI.json](assets/images/placeholder-small-file.png)][openapi.json]

[Click here to view/download OpenAPI spec](assets/OpenAPI.json)

<!-- <details>
  <summary>Click here to expand OpenAPI spec ...</summary>

```json
{% include_relative assets/OpenAPI.json %}
```
</details>  -->

### Request Handling

The [ESPF event][espf-event] generated by [EventSender][eventsender] contains a limited set of [variables][variables] (`event_type`, `i_account`, `i_env`, etc.), but external systems usually require more information (about the main product, add-ons, used quotas, etc.).

Therefore, the NSPS system makes API [requests][api-requests] to PortaBilling in order to get more information about the account, SIM, etc., which relates to the created event. The NSPS adds all the necessary [data][enriched-event] and passes it to the connector.

#### Request Body

NSPS sends the following request body to the connector (so the connector should accept it):

| Field Name   | Mandatory | Description                                                                                     |
| ------------ | --------- | ----------------------------------------------------------------------------------------------- |
| `pb_data`    | No        | Enriched data from PortaBilling; includes account, SIM, and access policy info. Defaults empty. |
| `data`       | Yes       | Event payload, represented by an instance of `ESPFEvent`.                                       |
| `handler_id` | No        | Optional identifier of the handler assigned to process the event.                               |
| `status`     | No        | Status of event processing. Defaults to `EventStatus.UNDEFINED`.                                |
| `created_at` | No        | Timestamp when the event was created.                                                           |
| `updated_at` | No        | Timestamp when the event was last enriched by NSPS.                                             |
| `event_id`   | Yes       | Unique identifier of the event.                                                                 |

The field called `data` contains the generated ESPF event as it is. So if you don't need additional info from PortaBilling, you can only use this data.

The data structure for the `pb_data` is shown below. It includes all possible fields. The connector should contain logic to process only the parameters it needs, and unnecessary ones can be ignored.

For a more detailed description of the parameters, please refer to [docs.portaone.com](https://docs.portaone.com/API/mr120/AccountInterface/#overview).

| Field Path                                                             | Mandatory | Type                            | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| ---------------------------------------------------------------------- | --------- | ------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `pb_data.account_info`                                                 | No        | `AccountInfo`                   | Main account-level data container                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| `pb_data.account_info.bill_status`                                     | No        | `str`                           | The billing status of the account.<br>Mapped values (originally single-letter codes):<br>- O → active<br>- S → suspended<br>- I → inactive<br>- C → terminated                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `pb_data.account_info.billing_model`                                   | No        | `str`                           | The account type.<br>Mapped values (originally int codes):<br>- -1 → debit_account<br>- 0 → recharge_voucher<br>- 1 → credit_account<br>- 2 → alias<br>- 4 → beneficiary                                                                                                                                                                                                                                                                                                                                                                                                         |
| `pb_data.account_info.blocked`                                         | No        | `bool`                          | Boolean conversion - Indicates whether account's calls and access to the self-care interface is blocked (originally Y/N string, converted Y → False, N → True)                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `pb_data.account_info.email`                                           | No        | `str`                           | The email address associated with the account                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `pb_data.account_info.firstname`                                       | No        | `str`                           | The account owner's first name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `pb_data.account_info.i_account`                                       | No        | `int`                           | Internal ID of the account. Visible in URL resource path on Admin UI page                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `pb_data.account_info.i_customer`                                      | No        | `int`                           | The ID of the customer record to which the account belongs                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `pb_data.account_info.i_master_account`                                | No        | `int`                           | The ID of the parent account                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| `pb_data.account_info.i_product`                                       | No        | `int`                           | The ID for the account's product                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `pb_data.account_info.i_vd_plan`                                       | No        | `int`                           | The unique ID of the bundle assigned to the account individually                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `pb_data.account_info.id`                                              | No        | `str`                           | Charging ID (MSISDN, ICCID or IMSI) of the account on the network. Visible as ID in Admin UI                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| `pb_data.account_info.lastname`                                        | No        | `str`                           | The account owner's last name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `pb_data.account_info.phone1`                                          | No        | `str`                           | The main phone number                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `pb_data.account_info.product_name`                                    | No        | `str`                           | The name of the account's product                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| `pb_data.account_info.status`                                          | No        | `str`                           | The current status of the account based on factors such as "expiration time", "activation time" etc.<br>Possible values:<br>- active<br>- customer_exported<br>- expired<br>- quarantine<br>- screening<br>- closed<br>- inactive<br>- customer_suspended<br>- customer_limited<br>- customer_provisionally_terminated<br>- blocked<br>- customer_blocked<br>- not_yet_active<br>- credit_exceeded<br>- overdraft<br>- customer_has_no_available_funds<br>- customer_credit_exceed<br>- zero_balance<br>- customer_suspension_delayed<br>- customer_limiting_delayed<br>- frozen |
| `pb_data.account_info.time_zone_name`                                  | No        | `str`                           | The name of the account's time zone. Examples: "Europe/Prague", "America/Vancouver", etc.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `pb_data.account_info.zip`                                             | No        | `str`                           | The postal (zip) code                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| `pb_data.account_info.assigned_addons`                                 | No        | `List[AssignedAddon]`           | The list of the account's add-on products                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| `pb_data.account_info.assigned_addons[].addon_effective_from`          | No        | `str`                           | ISO datetime string - The date and time when the add-on product is activated for an account                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| `pb_data.account_info.assigned_addons[].addon_effective_to`            | No        | `str`                           | ISO datetime string - The date and time when the add-on product assigned to an account expires                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `pb_data.account_info.assigned_addons[].addon_priority`                | No        | `int`                           | The priority level of the add-on product                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `pb_data.account_info.assigned_addons[].description`                   | No        | `str`                           | The internal product description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `pb_data.account_info.assigned_addons[].i_product`                     | No        | `int`                           | The unique ID of the product                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| `pb_data.account_info.assigned_addons[].i_product_group`               | No        | `int`                           | The unique ID of the product group to which the product belongs                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| `pb_data.account_info.assigned_addons[].i_vd_plan`                     | No        | `int`                           | The unique ID of the bundle assigned to the product                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| `pb_data.account_info.assigned_addons[].name`                          | No        | `str`                           | The product name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| `pb_data.account_info.service_features`                                | No        | `List[ServiceFeature]`          | The list of service features                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| `pb_data.account_info.service_features[].name`                         | No        | `str`                           | The service feature name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `pb_data.account_info.service_features[].effective_flag_value`         | No        | `str`                           | The actual service feature flag value. Possible values:<br>- 'Y' → enabled<br>- 'N' → disabled                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `pb_data.account_info.service_features[].attributes`                   | No        | `List[ServiceFeatureAttribute]` | The list of service feature attributes                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| `pb_data.account_info.service_features[].attributes[].name`            | No        | `str`                           | The service feature attribute internal name                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| `pb_data.account_info.service_features[].attributes[].effective_value` | No        | `str`                           | Service feature attribute value, comma-separated if multiple values                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| `pb_data.sim_info`                                                     | No        | `SimInfo`                       | SIM card information from PortaBilling                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| `pb_data.sim_info.i_account`                                           | No        | `int`                           | The unique ID of the account to which the SIM card belongs                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| `pb_data.sim_info.i_sim_card`                                          | No        | `int`                           | The unique ID of the SIM card                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| `pb_data.sim_info.iccid`                                               | No        | `str`                           | The Integrated Circuit Card ID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `pb_data.sim_info.imsi`                                                | No        | `str`                           | The unique International Mobile Subscriber Identity of the SIM card                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| `pb_data.sim_info.status`                                              | No        | `str`                           | The status of the SIM card                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |

#### Request Headers

NSPS sends the following headers to the connector used for tracing and debugging:

- [x-b3-traceid][x-b3-traceid]
- [x-request-id][x-request-id]

The connector should process them and add them to all log messages related to the processing of a specific request. If the headers were not delivered, the connector should generate unique values (for example, use UUID-compatible format).

#### Event Types

| Event type    | Trigger conditions | Most used fields |
| ------------- | ------------------ | ---------------- |
| **SIM/Updated** | - SIM card details have been changed, e.g., the default PIN for inactive SIM cards has been changed.<br>- The SIM card data specified in a custom field has been changed, e.g., the “Amazon” value is set in the “Marketplace” custom field.<br>- [SIM card status][sim-card-status] has been changed, e.g., from “In use” to “Disposed”.<br>- An account’s ID has changed. ([Account.id][account.id] has been updated.)<br>- Another product was assigned to the account. An account’s product has changed. (Account.i_product has been updated.)<br>- An account’s add-on product has been changed.<br>- An add-on product has been removed from an account.<br>- A new add-on product has been added for an account.<br>- The user has topped up (“recharged”) their bundle of any service type to get more service volume before bundle renewal.<br>- An account has exceeded its service usage quota (for services of all types except **Messaging** and **Internet access**).<br>- A service feature has been enabled/disabled for an account (the Service_Attribute_Values table has been updated).<br>- Custom information (e.g., ID card) has been added or changed for an account. (The Custom_Field_Values table has been updated for the account.)<br>- An account’s billing status has been changed or affected by the customer’s billing status. A customer’s status has changed. (Customers.bill_status has changed.)<br>- An account has been blocked. (Accounts.blocked set to ‘Y.’)<br>- An account has been unblocked. (Accounts.blocked set to ‘N.’)<br>- Bundle is successfully activated for the first time (the bundle has never been activated for this account before).<br>- Bundle is assigned to the account.<br>- [Bundle has expired][bundles] (for balance-dependent renewable type).<br>- Grace period for the bundle is over (for balance-dependant renewable type).<br>- Bundle is removed from the account.<br>- Bundle is automatically renewed for the account (for balance-dependant renewable type).<br>- Bundle is successfully activated after expiration (for balance-dependant renewable type). | `pb_data.sim_info.imsi`<br>`pb_data.account_info.i_account`<br>`pb_data.account_info.i_product`<br>`pb_data.account_info.bill_status`<br>`pb_data.account_info.blocked`<br>`pb_data.account_info.product_name`<br>`pb_data.account_info.assigned_addons[].i_product`<br>`pb_data.account_info.assigned_addons[].name`<br>`pb_data.account_info.assigned_addons[].i_vd_plan`<br>`pb_data.access_policy_info.attributes["name"=="cs_profile"].values[0]`<br>`pb_data.access_policy_info.attributes["name"=="eps_profile"].values[0]` |
| **SIM/Created** | A SIM card has been added to the inventory. | `pb_data.sim_info.imsi`<br>`pb_data.account_info.i_account` |
| **SIM/Deleted** | A SIM card has been removed from the inventory. | `pb_data.sim_info.imsi`<br>`pb_data.account_info.i_account` |
| **SIM/Replaced** | A SIM card has been assigned to, removed from, or changed for an account. | `pb_data.sim_info`<br>`pb_data.prev_sim_info` |

---

### Configuration

Typically, a connector should contain parameters that are needed to connect to the external system, as well as some that are needed by the application itself. The simplest and most straightforward option is to pass environment variables.

The connector must verify all requests by checking the Bearer token. Therefore, there is a need to set this token in the connector. It is recommended to set it as an environment variable (e.g., `API_TOKEN`) and read it in the code. This way, by changing only the environment variable, you can quickly update the access token in case it is compromised.

**Requirements:**

- Configurable bearer token to access the service.
- Configurable external system credentials.

### Logging

Logging is an important part that allows debugging when necessary.

**Requirements:**

- Logs should be written in JSON format (for search integration).
- Log `x-b3-traceid` header to `request_id` field.
- Log `x-request-id` header to `unique_id` field.

Logging these headers allows you to track all the events that occur with the event from its very beginning — entering the NSPS.

### Error Handling

- Errors should be logged.
- Each error response must contain a JSON body with an explanation of the reason for the error.

**Error Response Fields:**

- `message`: General description of the operation result (used in successful responses).
- `error`: Detailed error description, indicates failure processing results.
- `type`: Error type for programmatic handling (e.g., "CONNECTION_ERROR", "AUTHENTICATION_ERROR", "VALIDATION_ERROR").

<!-- References -->
[events]: https://docs.portaone.com/docs/mr121-events-that-espf-handlers-support?topic=eventsender-handler-events
[external-api-server]: https://swagger.io/docs/specification/v3_0/api-host-and-base-path/
[wtl-hlr/hss-connector]: https://gitlab.portaone.com:8949/read-only/wtl_hlr_hss_connector
[openapi.json]: https://wiki.portaone.com/display/REQSPEC/NSPS+Connector+Implementation+Guide?preview=/277253881/283843264/OpenAPI.json#NSPSConnectorImplementationGuide-Purpose
[espf-event]: https://docs.portaone.com/docs/mr121-events-that-espf-handlers-support?topic=eventsender-handler-events
[eventsender]: https://docs.portaone.com/docs/mr121-provisioning-via-webhooks?topic=provisioning-event-version
[variables]: https://docs.portaone.com/docs/mr121-provisioning-via-webhooks?topic=provisioning-event-version
[api-requests]: https://docs.portaone.com/
[account-interface]: https://docs.portaone.com/API/mr120/AccountInterface/#overview
[x-b3-traceid]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#x-b3-traceid
[x-request-id]: https://www.envoyproxy.io/docs/envoy/latest/configuration/http/http_conn_man/headers#x-request-id
[sim-card-status]: https://docs.portaone.com/docs/mr122-sim-card-inventory?topic=comprehensive-details-and-group-operations-in-sim-card-inventory
[account.id]: http://Account.id
[bundles]: https://docs.portaone.com/docs/mr122-balance-dependent-renewable-bundles

[openapi-spec]: ../assets/OpenAPI.json
[nsps]: NSPS/nsps-overview.md
[enriched-event]: NSPS/data-flows.md#output